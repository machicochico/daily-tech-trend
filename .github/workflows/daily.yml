name: daily-trend

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install -r requirements.txt
      - name: Debug db.py and init function
        run: |
          echo "=== Show src/db.py (head) ==="
          sed -n '1,200p' src/db.py
          echo "=== Try import src.db and list names ==="
          python -c "import src.db as d; print([n for n in dir(d) if 'init' in n]);"
          echo "=== Call init_db() ==="
          python -c "import src.db as d; d.init_db()"

      - run: python -c "from src.db import init_db; init_db()"
      - run: python src/feed_lint.py --config src/sources.yaml
      - run: python src/collect.py
      - name: Count articles by category (after collect)
        run: |
          python - <<'PY'
          import sqlite3
          conn=sqlite3.connect("data/state.sqlite")
          cur=conn.cursor()
          cur.execute("SELECT category, COUNT(*) FROM articles GROUP BY category ORDER BY COUNT(*) DESC")
          print("articles:", cur.fetchall())
          conn.close()
          PY

      - run: python src/normalize.py
      - run: python src/dedupe.py
      - run: python src/normalize_categories.py
      - run: python src/thread.py
      - name: Count topics by category (after thread)
        run: |
          python - <<'PY'
          import sqlite3
          conn=sqlite3.connect("data/state.sqlite")
          cur=conn.cursor()
          cur.execute("SELECT category, COUNT(*) FROM topics GROUP BY category ORDER BY COUNT(*) DESC")
          print("topics:", cur.fetchall())
          conn.close()
          PY

      - run: python src/translate.py
      - run: python src/render.py

      - run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add docs data/state.sqlite
          git commit -m "daily update" || exit 0
          git push
